#!/bin/bash
# Smart Test Strategy - {{PROJECT_NAME}}
# Generated by create-qa-architect (Pro/Team/Enterprise feature)
# https://buildproven.ai/qa-architect
set -e

echo "üß† Analyzing changes for optimal test strategy..."

# Environment variable overrides
if [[ "$SKIP_SMART" == "1" ]]; then
  echo "‚ö†Ô∏è  SKIP_SMART=1 - Running comprehensive tests"
  npm run test:comprehensive
  exit 0
fi

if [[ "$FORCE_COMPREHENSIVE" == "1" ]]; then
  echo "üî¥ FORCE_COMPREHENSIVE=1 - Running all tests"
  npm run test:comprehensive
  exit 0
fi

if [[ "$FORCE_MINIMAL" == "1" ]]; then
  echo "‚ö™ FORCE_MINIMAL=1 - Running lint only"
  npm run lint && npm run format:check
  exit 0
fi

# Collect metrics
CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD 2>/dev/null | wc -l | tr -d ' ')
CHANGED_LINES=$(git diff --stat HEAD~1..HEAD 2>/dev/null | tail -1 | grep -o '[0-9]* insertions' | grep -o '[0-9]*' || echo "0")
CURRENT_BRANCH=$(git branch --show-current)
HOUR=$(date +%H)
DAY_OF_WEEK=$(date +%u)

# Project-specific high-risk patterns (customized per project type)
# {{HIGH_RISK_PATTERN}}
HIGH_RISK_FILES=$(git diff --name-only HEAD~1..HEAD 2>/dev/null | grep -E "{{HIGH_RISK_REGEX}}" || true)
API_FILES=$(git diff --name-only HEAD~1..HEAD 2>/dev/null | grep -E "api/|routes/|endpoints/" || true)
CONFIG_FILES=$(git diff --name-only HEAD~1..HEAD 2>/dev/null | grep -E "(package\.json|\.env|config|tsconfig)" || true)
SECURITY_FILES=$(git diff --name-only HEAD~1..HEAD 2>/dev/null | grep -E "(auth|security|crypto|payment|billing)" || true)
TEST_FILES=$(git diff --name-only HEAD~1..HEAD 2>/dev/null | grep -E "test|spec|__tests__" || true)

# Calculate risk score (0-10)
RISK_SCORE=0

# File-based risk
[[ -n "$HIGH_RISK_FILES" ]] && RISK_SCORE=$((RISK_SCORE + 4))
[[ -n "$SECURITY_FILES" ]] && RISK_SCORE=$((RISK_SCORE + 3))
[[ -n "$API_FILES" ]] && RISK_SCORE=$((RISK_SCORE + 2))
[[ -n "$CONFIG_FILES" ]] && RISK_SCORE=$((RISK_SCORE + 2))

# Size-based risk
[[ $CHANGED_FILES -gt 10 ]] && RISK_SCORE=$((RISK_SCORE + 2))
[[ $CHANGED_FILES -gt 20 ]] && RISK_SCORE=$((RISK_SCORE + 3))
[[ $CHANGED_LINES -gt 200 ]] && RISK_SCORE=$((RISK_SCORE + 2))

# Branch-based risk
case $CURRENT_BRANCH in
  main|master|production) RISK_SCORE=$((RISK_SCORE + 3)) ;;
  hotfix/*) RISK_SCORE=$((RISK_SCORE + 4)) ;;
  release/*) RISK_SCORE=$((RISK_SCORE + 2)) ;;
  develop) RISK_SCORE=$((RISK_SCORE + 1)) ;;
esac

# Time pressure adjustment (strip leading zeros for arithmetic)
HOUR_NUM=$((10#$HOUR))
if [[ $HOUR_NUM -ge 9 && $HOUR_NUM -le 17 && $DAY_OF_WEEK -le 5 ]]; then
  echo "‚è∞ Work hours - Optimizing for speed"
  SPEED_BONUS=true
else
  SPEED_BONUS=false
fi

# Display analysis
echo ""
echo "üìä Analysis Results:"
echo "   üìÅ Files changed: $CHANGED_FILES"
echo "   üìè Lines changed: $CHANGED_LINES"
echo "   üåø Branch: $CURRENT_BRANCH"
echo "   üéØ Risk Score: $RISK_SCORE/10"
echo "   ‚ö° Speed Bonus: $SPEED_BONUS"
echo ""

# Test tier selection based on risk score
# NOTE: E2E tests and slow command tests are ALWAYS excluded from pre-push
# - E2E tests: Require dev server, browsers, proper infrastructure (run in CI only)
# - Command tests: Take 60+ seconds, verify npm scripts work (run in CI only)
# These run in GitHub Actions on every PR and push to main

if [[ $RISK_SCORE -ge 7 ]]; then
  echo "üî¥ HIGH RISK - Comprehensive validation (pre-push)"
  echo "   ‚Ä¢ Unit + integration tests + security audit"
  echo "   ‚Ä¢ (E2E and command tests run in CI only)"
  # {{COMPREHENSIVE_COMMAND}}
  {{TEST_COMPREHENSIVE}}
elif [[ $RISK_SCORE -ge 4 ]]; then
  echo "üü° MEDIUM RISK - Standard validation"
  echo "   ‚Ä¢ Fast tests + integration (excludes slow tests)"
  # {{MEDIUM_COMMAND}}
  {{TEST_MEDIUM}}
elif [[ $RISK_SCORE -ge 2 || "$SPEED_BONUS" == "false" ]]; then
  echo "üü¢ LOW RISK - Fast validation"
  echo "   ‚Ä¢ Unit tests only"
  # {{FAST_COMMAND}}
  {{TEST_FAST}}
else
  echo "‚ö™ MINIMAL RISK - Quality checks only"
  echo "   ‚Ä¢ Lint + format check"
  # {{MINIMAL_COMMAND}}
  {{TEST_MINIMAL}}
fi

echo ""
echo "üí° Tip: Run 'npm run test:comprehensive' locally for full validation"
echo "üíé Smart Test Strategy powered by QA Architect Pro"
