/**
 * Security-First Configuration Enhancements
 * Comprehensive security scanning and validation by default
 */

const fs = require('fs')
const path = require('path')

/**
 * Generate enhanced security configuration
 * Makes security scanning the default, not optional
 */
function generateSecurityFirstConfig() {
  const securityConfig = {
    // Secret scanning configuration
    gitleaks: {
      enabled: true,
      configPath: '.gitleaks.toml',
      blockCommits: true,
      scanHistory: false, // Don't scan full history by default for performance
    },

    // Dependency vulnerability scanning
    npm: {
      audit: {
        enabled: true,
        level: 'high', // Only block on high/critical vulnerabilities
        autoFix: true,
        excludePatterns: [],
      },
    },

    // ESLint security rules
    eslint: {
      security: {
        enabled: true,
        rules: {
          'security/detect-object-injection': 'error',
          'security/detect-non-literal-regexp': 'error',
          'security/detect-unsafe-regex': 'error',
          'security/detect-eval-with-expression': 'error',
          'security/detect-no-csrf-before-method-override': 'error',
        },
      },
    },

    // GitHub Actions security
    github: {
      actionlint: {
        enabled: true,
        blockWorkflows: true,
      },
      dependabot: {
        enabled: true,
        autoMerge: false, // Manual review required
      },
    },
  }

  return securityConfig
}

/**
 * Generate comprehensive security npm scripts
 */
function getSecurityScripts() {
  return {
    // Core security audit commands (auto-detect pnpm/yarn/npm)
    'security:audit':
      '[ -f pnpm-lock.yaml ] && pnpm audit --audit-level high || [ -f yarn.lock ] && yarn audit || npm audit --audit-level high',
    'security:audit:fix':
      '[ -f pnpm-lock.yaml ] && pnpm audit --fix || [ -f yarn.lock ] && yarn audit --fix || npm audit fix',
    'security:secrets': 'npx gitleaks detect --no-banner --redact --verbose',
    'security:secrets:baseline':
      'npx gitleaks detect --no-banner --redact --baseline-path .gitleaksignore',

    // Comprehensive security check (all tools)
    'security:check':
      'npm run security:audit && npm run security:secrets && npm run security:eslint',
    'security:eslint': 'npx eslint . --config eslint-security.config.js',

    // CI/CD security validation
    'security:ci': 'npm run security:check && npm run validate:workflows',
    'validate:workflows': 'npx actionlint .github/workflows/*.yml',

    // Security reporting
    'security:report': 'npm run security:check > security-report.txt 2>&1',
    'security:baseline':
      'npm run security:secrets:baseline && npm run security:audit',
  }
}

/**
 * Generate .gitleaks.toml configuration
 * Comprehensive secret detection patterns
 */
function generateGitleaksConfig() {
  return `# Gitleaks configuration for comprehensive secret detection
# Generated by create-qa-architect

[extend]
# Use default gitleaks rules as base
useDefault = true

# Additional custom patterns for common secrets
[[rules]]
description = "JWT tokens"
id = "jwt-token"
regex = '''eyJ[A-Za-z0-9_/+-]{10,}={0,2}'''
tags = ["key", "JWT"]

[[rules]]
description = "Environment variable secrets"
id = "env-secret"
regex = '''(?i)(api_key|secret|password|token)\\s*=\\s*['""][^'"\\s]{10,}['""]'''
tags = ["env", "secret"]

# Allowlist for test/example files (broad exclusion)
[allowlist]
description = "Test and example files"
regexes = ['''test_secret_.*|example_.*|dummy_.*|fake_.*|EXAMPLE_.*|your_.*_here|replace_with_.*|TODO:.*''']
paths = ['''(tests/|test/|__tests__/|examples/|docs/|\\.md$|\\.gitleaksignore$|node_modules/|dist/|build/|\\.next/|coverage/)''']
`
}

/**
 * Generate eslint-security.config.js for security-specific linting
 */
function generateEslintSecurityConfig() {
  return `// ESLint security configuration
// Generated by create-qa-architect

const security = require('eslint-plugin-security')

module.exports = [
  {
    plugins: {
      security
    },
    rules: {
      // Critical security rules (errors)
      'security/detect-object-injection': 'error',
      'security/detect-non-literal-regexp': 'error',
      'security/detect-unsafe-regex': 'error',
      'security/detect-eval-with-expression': 'error',
      'security/detect-no-csrf-before-method-override': 'error',
      'security/detect-buffer-noassert': 'error',
      'security/detect-child-process': 'error',
      'security/detect-disable-mustache-escape': 'error',
      'security/detect-new-buffer': 'error',
      'security/detect-possible-timing-attacks': 'error',
      'security/detect-pseudoRandomBytes': 'error',

      // Warning-level security rules
      'security/detect-bidi-characters': 'warn',
      'security/detect-non-literal-fs-filename': 'warn',
      'security/detect-non-literal-require': 'warn'
    }
  }
]
`
}

/**
 * Apply security-first configuration to project
 */
function applySecurityFirstConfiguration(projectPath = '.') {
  const securityFixes = []

  // 1. Generate .gitleaks.toml
  const gitleaksConfigPath = path.join(projectPath, '.gitleaks.toml')
  if (!fs.existsSync(gitleaksConfigPath)) {
    fs.writeFileSync(gitleaksConfigPath, generateGitleaksConfig())
    securityFixes.push(
      '✅ Created .gitleaks.toml - comprehensive secret detection'
    )
  }

  // 2. Generate eslint-security.config.js
  const eslintSecurityPath = path.join(projectPath, 'eslint-security.config.js')
  if (!fs.existsSync(eslintSecurityPath)) {
    fs.writeFileSync(eslintSecurityPath, generateEslintSecurityConfig())
    securityFixes.push(
      '✅ Created eslint-security.config.js - security-focused linting'
    )
  }

  // 3. Create .gitleaksignore for managing false positives
  const gitleaksIgnorePath = path.join(projectPath, '.gitleaksignore')
  if (!fs.existsSync(gitleaksIgnorePath)) {
    const ignoreContent = `# Gitleaks ignore file
# Add specific secrets that are false positives or test data
# Format: <rule-id>:<file-path>:<line-number>:<commit-hash>

# Example:
# jwt-token:tests/fixtures/example.js:15:abc123def456
`
    fs.writeFileSync(gitleaksIgnorePath, ignoreContent)
    securityFixes.push('✅ Created .gitleaksignore - manage false positives')
  }

  // 4. Generate security documentation
  const securityDocsPath = path.join(projectPath, 'SECURITY.md')
  if (!fs.existsSync(securityDocsPath)) {
    const securityDocs = generateSecurityDocumentation()
    fs.writeFileSync(securityDocsPath, securityDocs)
    securityFixes.push(
      '✅ Created SECURITY.md - security policies and procedures'
    )
  }

  return securityFixes
}

/**
 * Generate SECURITY.md documentation
 */
function generateSecurityDocumentation() {
  return `# Security Policy

## Automated Security Scanning

This project uses multiple layers of automated security scanning:

### Secret Detection
- **Tool**: Gitleaks
- **Configuration**: \`.gitleaks.toml\`
- **Coverage**: API keys, passwords, tokens, certificates
- **Pre-commit**: Blocks commits containing secrets
- **CI/CD**: Scans all pull requests

### Dependency Scanning
- **Tool**: npm audit
- **Level**: High and critical vulnerabilities only
- **Auto-fix**: Enabled for compatible updates
- **CI/CD**: Fails builds on high/critical vulnerabilities

### Code Security Scanning
- **Tool**: ESLint security plugin
- **Configuration**: \`eslint-security.config.js\`
- **Coverage**: Injection attacks, unsafe patterns, crypto issues
- **Pre-commit**: Blocks commits with security violations

### Workflow Security
- **Tool**: actionlint
- **Coverage**: GitHub Actions workflow security issues
- **CI/CD**: Validates workflow syntax and security

## Manual Security Commands

\`\`\`bash
# Run all security checks
npm run security:check

# Check for secrets
npm run security:secrets

# Check dependencies
npm run security:audit

# Fix dependency issues
npm run security:audit:fix

# Generate security report
npm run security:report
\`\`\`

## Reporting Security Issues

If you discover a security vulnerability:

1. **DO NOT** create a public GitHub issue
2. Email security reports to: [Your security email]
3. Include:
   - Description of the vulnerability
   - Steps to reproduce
   - Potential impact
   - Suggested fix (if known)

## Security Best Practices

### For Developers
- Never commit secrets, API keys, or passwords
- Use environment variables for sensitive configuration
- Run \`npm run security:check\` before pushing
- Keep dependencies updated
- Review security scanner output carefully

### For CI/CD
- All security checks must pass before merge
- Dependency updates require security review
- Secrets stored in secure environment variables
- Regular security audits in automated schedules

## Security Contact

For security-related questions: [Your contact information]

## Policy Updates

This security policy is reviewed and updated quarterly.
Last updated: [Current date]
`
}

module.exports = {
  generateSecurityFirstConfig,
  getSecurityScripts,
  generateGitleaksConfig,
  generateEslintSecurityConfig,
  applySecurityFirstConfiguration,
  generateSecurityDocumentation,
}
